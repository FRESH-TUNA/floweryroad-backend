version: '3'

services:
  db:
    env_file: 
      - ./db_credential.env
    image: postgres
    volumes:
      - ../db_volume:/var/lib/postgresql/data
    depends_on: # 서비스 간의 종속성 표현
      - web
  
  nginx:
    image: nginx:latest # nginx 서비스에서 사용할 도커 이미지
    ports:
      - "80:80"
    volumes:
      volumes:
      - ../../static:/static  
      - ../../static:/media
      - ../../settings/.server/nginx-app.conf:/etc/nginx/conf.d/nginx.conf
    depends_on: # 서비스 간의 종속성 표현
      - web

  web:
    env_file: 
      - ./credential.env
    image: floweryroad-backend:1.1.0

    volumes:
      - /Users/kimdongwon/Documents/WebProgramming/Projects/Floweryroad/floweryroad-backend/:/app/floweryroad-backend

    ports:
      - "80:80"

    command: 
      - /bin/bash
      - -c
      - |
        cp -f /app/floweryroad-backend/floweryroad/settings/.server/nginx-app.conf /etc/nginx/sites-available/nginx-app.conf
        ln -sf /etc/nginx/sites-available/nginx-app.conf /etc/nginx/sites-enabled/nginx-app.conf
        cp -f /app/floweryroad-backend/floweryroad/settings/.server/uwsgi.service /etc/systemd/system/uwsgi.service
        supervisord
  
